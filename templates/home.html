{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineMarket - Catálogo</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/css.css' %}">
</head>

<body>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark px-4">
        <a class="navbar-brand d-flex align-items-center gap-2" href="{% url 'home' %}">
            <span class="fs-4 fw-bold brand-accent">CineMarket</span>
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="mainNav">

            <!-- LINKS CENTRO -->
            <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link fw-semibold active" href="{% url 'home' %}">Catálogo</a></li>
                <li class="nav-item"><a class="nav-link fw-semibold" href="{% url 'arriendos:historial' %}">Historial</a></li>
                <li class="nav-item"><a class="nav-link fw-semibold" href="{% url 'peliculas:recomendaciones' %}">Recomendaciones</a></li>
            </ul>

            <!-- BARRA DE BÚSQUEDA -->
            <form class="d-none d-lg-flex me-3 w-50" method="GET" action="{% url 'home' %}">
                <div class="input-group search-pill px-3 py-1 w-100">
                    <input
                        type="text"
                        name="q"
                        value="{{ q }}"
                        class="form-control form-control-lg"
                        placeholder="Buscar película..."
                    >
                    <button class="btn btn-link text-dark px-1" type="submit"></button>
                </div>
            </form>

            <!-- LOGIN / REGISTRO -->
            <div class="d-flex align-items-center gap-2">

                {% if user.is_authenticated %}
                    <span class="text-light small me-1">{{ user.username }}</span>

                    <a href="{% url 'mi_perfil' %}" class="btn btn-outline-light btn-sm me-1">
                        Mi perfil
                    </a>

                    {% if user.is_staff %}
                        <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-light btn-sm">Admin</a>
                    {% endif %}

                    <a href="{% url 'logout' %}" class="btn btn-light btn-sm">Salir</a>

                {% else %}

                    <div class="dropdown">
                        <button class="btn btn-outline-light btn-sm rounded-pill px-3 dropdown-toggle"
                                type="button" data-bs-toggle="dropdown">
                            Ingresar
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark">
                            <li><a class="dropdown-item" href="{% url 'login' %}">Iniciar sesión</a></li>
                            <li><a class="dropdown-item" href="{% url 'registro' %}">Registrarse</a></li>
                        </ul>
                    </div>

                {% endif %}

            </div>

        </div>
    </nav>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="container-fluid py-4">

        {% if peliculas %}
        <!-- HERO / CARRUSEL -->
        <section class="mb-4">

            <div id="heroCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="5000">

                <div class="carousel-inner rounded-4 overflow-hidden shadow-lg">

                    {% for p in peliculas %}
                    <div class="carousel-item {% if forloop.first %}active{% endif %}">
                        <div class="position-relative">

                            {% if p.imagen %}
                                <img src="{{ p.imagen.url }}" class="hero-img" alt="{{ p.titulo }}">
                            {% else %}
                                <div class="hero-img" style="background: linear-gradient(135deg,#0f172a,#1d4ed8);"></div>
                            {% endif %}

                            <div class="hero-overlay d-flex align-items-center">
                                <div class="hero-overlay-content px-4 px-md-5 py-4 py-md-0">

                                    <span class="badge bg-primary mb-2">Destacado</span>

                                    <h1 class="display-6 fw-bold mb-2">{{ p.titulo }}</h1>

                                    <p class="mb-2 hero-meta">
                                        {{ p.genero }} • {{ p.anio }}
                                        {% if p.calificacion %} • ⭐ {{ p.calificacion }}/5{% endif %}
                                    </p>

                                    <p class="lead text-light-50 mb-3" style="max-width: 680px;">
                                        {{ p.descripcion|default:"Sinopsis no disponible."|truncatechars:220 }}
                                    </p>

                                    <div class="d-flex flex-wrap gap-2">

                                        <a href="{% url 'pagos:iniciar_pago' p.id 'arriendo' %}"
                                           class="btn btn-primary btn-lg">
                                            Arrendar por ${{ p.precio_arriendo|floatformat:0 }}
                                        </a>

                                        <a href="{% url 'pagos:iniciar_pago' p.id 'compra' %}"
                                           class="btn btn-outline-light btn-lg">
                                            Comprar por ${{ p.precio_compra|floatformat:0 }}
                                        </a>

                                    </div>

                                </div>
                            </div>

                        </div>
                    </div>
                    {% endfor %}

                </div>

                <!-- FLECHAS -->
                <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon"></span>
                </button>

                <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon"></span>
                </button>

            </div>

        </section>
        {% endif %}

        <!-- FILTRO POR GÉNERO -->
        <section class="mb-3">
            <div class="d-flex flex-wrap align-items-center gap-2">

                <span class="text-muted small text-uppercase">Explorar por género</span>

                <a href="?{% if q %}q={{ q|urlencode }}&{% endif %}genre=Todos"
                   class="btn btn-sm btn-outline-light genre-pill {% if not genre or genre|lower == 'todos' %}active{% endif %}">
                    Todos
                </a>

                <a href="?{% if q %}q={{ q|urlencode }}&{% endif %}genre=Acción"
                   class="btn btn-sm btn-outline-light genre-pill {% if genre == 'Acción' %}active{% endif %}">
                    Acción
                </a>

                <a href="?{% if q %}q={{ q|urlencode }}&{% endif %}genre=Terror"
                   class="btn btn-sm btn-outline-light genre-pill {% if genre == 'Terror' %}active{% endif %}">
                    Terror
                </a>

                <a href="?{% if q %}q={{ q|urlencode }}&{% endif %}genre=Romance"
                   class="btn btn-sm btn-outline-light genre-pill {% if genre == 'Romance' %}active{% endif %}">
                    Romance
                </a>

                <a href="?{% if q %}q={{ q|urlencode }}&{% endif %}genre=Comedia"
                   class="btn btn-sm btn-outline-light genre-pill {% if genre == 'Comedia' %}active{% endif %}">
                    Comedia
                </a>

                <a href="?{% if q %}q={{ q|urlencode }}&{% endif %}genre=Infantil"
                   class="btn btn-sm btn-outline-light genre-pill {% if genre == 'Infantil' %}active{% endif %}">
                    Infantil
                </a>

            </div>
        </section>

        <!-- GRID DE PELÍCULAS -->
        <section>
            <div class="r
