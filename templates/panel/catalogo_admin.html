{% extends 'panel/base_admin.html' %}
{% load static %}

{% block title %}Cat√°logo - Panel Admin{% endblock %}
{% block nav_catalogo_active %}active{% endblock %}

{% block content %}
<div class="container-fluid py-3">

  <!-- Encabezado -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-0">Cat√°logo</h3>
      <small class="text-muted">Administra las pel√≠culas disponibles en CineMarket.</small>
    </div>
    <span class="badge bg-primary-subtle text-primary border border-primary">
      <i class="bi bi-collection-play me-1"></i> {{ total }} pel√≠cula{{ total|pluralize:"s" }}
    </span>
  </div>

  <div class="row g-4">

    <!-- Columna izquierda: Nueva pel√≠cula -->
    <div class="col-12 col-lg-4 col-xl-3">
      <form method="post" enctype="multipart/form-data" class="card border-0 shadow-sm rounded-4 p-3">
        {% csrf_token %}
        <input type="hidden" name="_accion" value="crear">

        <div class="d-flex align-items-center mb-2">
          <div class="rounded-circle bg-dark me-2" style="width:10px;height:10px;"></div>
          <h5 class="m-0">Nueva pel√≠cula</h5>
        </div>

        <!-- T√≠tulo -->
        <div class="form-floating mb-3">
          <input type="text" class="form-control" id="titulo" name="titulo" placeholder="T√≠tulo" required>
          <label for="titulo">T√≠tulo</label>
        </div>

        <div class="row g-3">
          <!-- G√©nero -->
          <div class="col-12 col-md-6">
            <div class="form-floating">
              <input type="text" class="form-control" id="genero" name="genero" placeholder="Acci√≥n, Terror‚Ä¶" required>
              <label for="genero">G√©nero</label>
            </div>
          </div>

          <!-- A√±o -->
          <div class="col-12 col-md-6">
            <div class="form-floating">
              <input type="number" class="form-control" id="anio" name="anio" placeholder="2025" min="1900" max="2100" required>
              <label for="anio">A√±o</label>
            </div>
          </div>

          <!-- Precio -->
          <div class="col-12 col-md-6">
            <div class="input-group flex-nowrap">
              <span class="input-group-text">$</span>
              <input
                type="number"
                class="form-control text-end"
                id="precio_arriendo"
                name="precio_arriendo"
                step="10" min="0"
                inputmode="numeric" placeholder="2990" aria-label="Precio arriendo" required>
              <span class="input-group-text">CLP</span>
            </div>
            <div class="form-text">Precio de arriendo</div>
          </div>

          <!-- Calificaci√≥n -->
          <div class="col-12 col-md-6">
            <div class="input-group flex-nowrap">
              <span class="input-group-text">‚≠ê</span>
              <input
                type="number"
                class="form-control text-end"
                id="calificacion"
                name="calificacion"
                step="0.1" min="0" max="5"
                placeholder="4.5" required>
              <span class="input-group-text">/5</span>
            </div>
            <div class="form-text">Calificaci√≥n</div>
          </div>
        </div>

        <!-- Disponible -->
        <input type="hidden" name="disponible" value="0">
        <div class="form-check form-switch mt-3">
          <input class="form-check-input" type="checkbox" role="switch" id="disponible" name="disponible" value="1" checked>
          <label class="form-check-label" for="disponible">Disponible</label>
        </div>

        <!-- Imagen + preview -->
        <div class="mt-3">
          <label class="form-label">Imagen</label>
          <input class="form-control" type="file" id="imagen" name="imagen" accept="image/*">
          <div class="border rounded-3 mt-2 p-2 text-center bg-light" id="previewBox" style="display:none;">
            <img id="previewImg" class="img-fluid rounded-3" alt="Preview">
          </div>
          <div class="form-text">Opcional. JPG/PNG</div>
        </div>

        <!-- Descripci√≥n -->
        <div class="form-floating mt-3">
          <textarea class="form-control" placeholder="Sinopsis, notas‚Ä¶" id="descripcion" name="descripcion" style="height: 120px;"></textarea>
          <label for="descripcion">Descripci√≥n (opcional)</label>
        </div>

        <!-- Acciones -->
        <div class="d-grid gap-2 mt-3">
          <button type="submit" class="btn btn-dark">Agregar</button>
          <button type="reset" class="btn btn-outline-secondary">Limpiar</button>
        </div>
      </form>
    </div>

    <!-- Columna derecha: listado -->
    <div class="col-12 col-lg-8 col-xl-9">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="m-0 text-muted">Listado de pel√≠culas</h6>

        <form class="d-flex" method="get">
          <input class="form-control form-control-sm" name="q" value="{{ q }}" placeholder="Buscar por t√≠tulo‚Ä¶">
        </form>
      </div>

      <div class="table-responsive card border-0 shadow-sm rounded-4">
        <table class="table align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:36%">T√≠tulo</th>
              <th>G√©nero</th>
              <th>A√±o</th>
              <th>Precio</th>
              <th>Rating</th>
              <th>Disponible</th>
              <th class="text-end" style="width:120px">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for p in peliculas %}
            <tr>
              <td class="fw-semibold">
                <div class="d-flex align-items-center gap-2">
                  {% if p.imagen %}
                    <img src="{{ p.imagen.url }}" alt="" class="rounded" style="width:42px;height:42px;object-fit:cover;">
                  {% else %}
                    <div class="rounded bg-light d-flex align-items-center justify-content-center"
                         style="width:42px;height:42px;">üéûÔ∏è</div>
                  {% endif %}
                  <span>{{ p.titulo }}</span>
                </div>
              </td>
              <td>{{ p.genero }}</td>
              <td>{{ p.anio }}</td>
              <td>${{ p.precio_arriendo|floatformat:0 }}</td>
              <td>{{ p.calificacion|floatformat:1 }}</td>
              <td>
                {% if p.disponible %}
                  <span class="badge bg-dark">S√≠</span>
                {% else %}
                  <span class="badge bg-secondary">No</span>
                {% endif %}
              </td>
              <td class="text-end">
                <a href="{% url 'admin_pelicula_editar' p.id %}" class="btn btn-sm btn-outline-secondary" title="Editar">
                  <i class="bi bi-pencil"></i>
                </a>
                <a href="{% url 'admin_pelicula_eliminar' p.id %}" class="btn btn-sm btn-outline-danger" title="Eliminar">
                  <i class="bi bi-trash"></i>
                </a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center py-4 text-muted">
                No hay pel√≠culas registradas.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Paginaci√≥n -->
      {% if peliculas.paginator.num_pages > 1 %}
      <nav class="mt-3">
        <ul class="pagination pagination-sm mb-0">
          {% if peliculas.has_previous %}
            <li class="page-item"><a class="page-link" href="?page={{ peliculas.previous_page_number }}&q={{ q }}">¬´</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">¬´</span></li>
          {% endif %}

          {% for i in peliculas.paginator.page_range %}
            {% if i == peliculas.number %}
              <li class="page-item active"><span class="page-link">{{ i }}</span></li>
            {% else %}
              <li class="page-item"><a class="page-link" href="?page={{ i }}&q={{ q }}">{{ i }}</a></li>
            {% endif %}
          {% endfor %}

          {% if peliculas.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ peliculas.next_page_number }}&q={{ q }}">¬ª</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">¬ª</span></li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    </div>
  </div>
</div>

<!-- Helpers UI -->
{% block extra_js %}
<script>
  const inputImg = document.getElementById('imagen');
  const box = document.getElementById('previewBox');
  const img = document.getElementById('previewImg');
  if (inputImg) {
    inputImg.addEventListener('change', e => {
      const f = e.target.files?.[0];
      if (!f) { box.style.display = 'none'; return; }
      const url = URL.createObjectURL(f);
      img.src = url;
      box.style.display = 'block';
    });
  }

  const rate = document.getElementById('calificacion');
  if (rate) {
    rate.addEventListener('blur', () => {
      let v = parseFloat(rate.value || 0);
      if (isNaN(v)) v = 0;
      v = Math.max(0, Math.min(5, v));
      rate.value = (Math.round(v * 10) / 10).toFixed(1);
    });
  }
</script>
{% endblock %}
{% endblock %}
